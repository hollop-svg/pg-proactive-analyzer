<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Информация о БД</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="menu" id="menu"></div>
    <script src ="menu-loader.js"></script>

  <div class="main">
    
      <header>
        <h1>Информация о базе данных</h1>
        <p>Подробная информация о структуре и состоянии базы данных</p>
      </header>
<div class="container">
      <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Загрузка данных о базе данных...</p>
      </div>

      <div id="error" class="error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <p>Ошибка загрузки данных. Проверьте подключение к API.</p>
      </div>

      <div id="db-content" style="display: none;">
        <div class="stats" id="db-summary">
          <!-- Общая информация будет добавлена динамически -->
        </div>

        <div class="table-container">
          <div class="table-header">
            <h2>Таблицы в базе данных</h2>
          </div>
          <table id="tables-info">
            <thead>
              <tr>
                <th>Название</th>
                <th>Размер</th>
                <th>Индексы</th>
                <th>Последнее обновление</th>
              </tr>
            </thead>
            <tbody>
              <!-- Данные таблиц будут добавлены динамически -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Показываем индикатор загрузки
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('db-content').style.display = 'none';

        // Запрос к API для получения данных о БД
        const response = await fetch("http://192.168.1.47:8000/dbinfo");
        
        if (!response.ok) {
          throw new Error(`Ошибка API: ${response.status}`);
        }

        const data = await response.json();

        // Если соединения нет
        if (!data || !data.dbname) {
          throw new Error("Нет данных о базе данных");
        }

        // Скрываем индикатор загрузки
        document.getElementById('loading').style.display = 'none';
        document.getElementById('db-content').style.display = 'block';

        // Функция для форматирования размера в читаемый вид
        function formatBytes(bytes, decimals = 2) {
          if (bytes === 0) return '0 Bytes';
          
          const k = 1024;
          const dm = decimals < 0 ? 0 : decimals;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
          
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          
          return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
          if (!dateString) return '-';
          
          const date = new Date(dateString);
          return date.toLocaleString('ru-RU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        }

        // Общая информация
        document.getElementById("db-summary").innerHTML = `
          <div class="stat">
            <div class="stat-icon db-icon">
              <i class="fas fa-database"></i>
            </div>
            <h3>Имя БД</h3>
            <p>${data.dbname}</p>
          </div>
          <div class="stat">
            <div class="stat-icon size-icon">
              <i class="fas fa-weight-hanging"></i>
            </div>
            <h3>Размер БД</h3>
            <p>${formatBytes(data.dbsize_bytes)}</p>
          </div>
          <div class="stat">
            <div class="stat-icon table-icon">
              <i class="fas fa-table"></i>
            </div>
            <h3>Количество таблиц</h3>
            <p>${data.table_count}</p>
          </div>
          <div class="stat">
            <div class="stat-icon user-icon">
              <i class="fas fa-users"></i>
            </div>
            <h3>Пользователей</h3>
            <p>${data.user_count}</p>
          </div>
        `;

        // Таблицы
        const tbody = document.querySelector("#tables-info tbody");
        tbody.innerHTML = ""; // очищаем перед вставкой

        data.tables.forEach(tbl => {
          const row = document.createElement("tr");
          
          row.innerHTML = `
            <td>${tbl.name}</td>
            <td class="size-bytes">${formatBytes(tbl.size_bytes)}</td>
            <td>
              <div class="indexes-list">
                ${tbl.indexes && tbl.indexes.length ? 
                  tbl.indexes.map(index => `<span class="index-tag">${index}</span>`).join('') : 
                  "-"}
              </div>
            </td>
            <td class="last-updates">
              <div class="update-item"><strong>Автовакуум:</strong> ${formatDate(tbl.last_update.last_autovacuum)}</div>
              <div class="update-item"><strong>Автоанализ:</strong> ${formatDate(tbl.last_update.last_autoanalyze)}</div>           
            </td>
          `;
          tbody.appendChild(row);
        });

      } catch (err) {
        console.error("Ошибка при загрузке данных:", err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = `
          <i class="fas fa-exclamation-circle"></i>
          <p>Ошибка: ${err.message}</p>
          <p>Сначала подключитесь к БД на главной странице</p>
        `;
      }
    });
  </script>
</body>
</html>