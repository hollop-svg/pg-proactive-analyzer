<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Тепловая карта проблем — SQL Guardian</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .heatmap-container { max-width: 1200px; margin: 0 auto; }
    .heatmap-header { margin-bottom: 30px; }
    .heatmap-header h1 { font-size: 28px; color: #1e293b; }
    .heatmap-header p { color: #64748b; }
    .stats-grid { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .stat { background: #fff; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-width: 180px; }
    .charts-row { display: flex; gap: 30px; flex-wrap: wrap; }
    .chart-block { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; flex: 1; min-width: 350px; }
    .top-list { margin-top: 30px; }
    .top-list h3 { margin-bottom: 10px; }
    .top-list ul { list-style: none; padding: 0; }
    .top-list li { background: #f8fafc; margin-bottom: 8px; padding: 10px 15px; border-radius: 8px; }
    .filter-bar { margin-bottom: 20px; display: flex; gap: 15px; }
    .filter-bar select, .filter-bar input { padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; }
  </style>
</head>
<body>
  <div class="menu" id="menu"></div>
  <script src="menu-loader.js"></script>
  <div class="main">
    <div class="heatmap-container">
      <div class="heatmap-header">
        <h1>Тепловая карта проблем</h1>
        <p>Визуализация частоты и типов проблем по таблицам и времени</p>
      </div>
      <div class="stats-grid" id="heatmap-stats"></div>
      <div class="filter-bar">
        <select id="tableFilter">
          <option value="">Все таблицы</option>
        </select>
        <select id="issueFilter">
          <option value="">Все типы проблем</option>
        </select>
        <input type="text" id="hourFilter" placeholder="Час (00-23)">
      </div>
      <div class="charts-row">
        <div class="chart-block">
          <h3>Распределение проблем по часам</h3>
          <canvas id="hourChart"></canvas>
        </div>
        <div class="chart-block">
          <h3>Топ-таблицы по количеству проблем</h3>
          <canvas id="tableChart"></canvas>
        </div>
        <div class="chart-block">
          <h3>Типы проблем</h3>
          <canvas id="issueChart"></canvas>
        </div>
      </div>
      <div class="top-list">
        <h3>Топ-таблицы</h3>
        <ul id="topTables"></ul>
        <h3>Топ-проблемы</h3>
        <ul id="topIssues"></ul>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("http://192.168.1.47:8000/heatmap");
      const data = await res.json();

      const totalIssues = Object.values(data.issues).reduce((a,b)=>a+b,0);
      const topTable = Object.entries(data.by_table).sort((a,b)=>b[1]-a[1])[0];
      const topHour = Object.entries(data.by_hour).sort((a,b)=>b[1]-a[1])[0];
      document.getElementById("heatmap-stats").innerHTML = `
        <div class="stat">
          <h3>Всего проблем</h3>
          <p>${totalIssues}</p>
        </div>
        <div class="stat">
          <h3>Топ-таблица</h3>
          <p>${topTable ? topTable[0] : '-'}</p>
        </div>
        <div class="stat">
          <h3>Самый "горячий" час</h3>
          <p>${topHour ? topHour[0]+":00" : '-'}</p>
        </div>
        <div class="stat">
          <h3>Типов проблем</h3>
          <p>${Object.keys(data.issues).length}</p>
        </div>
      `;

      const tableFilter = document.getElementById("tableFilter");
      Object.keys(data.by_table).forEach(tbl => {
        const opt = document.createElement("option");
        opt.value = tbl;
        opt.textContent = tbl;
        tableFilter.appendChild(opt);
      });
      const issueFilter = document.getElementById("issueFilter");
      Object.keys(data.issues).forEach(issue => {
        const opt = document.createElement("option");
        opt.value = issue;
        opt.textContent = issue;
        issueFilter.appendChild(opt);
      });

      const hourLabels = Array.from({length:24}, (_,i)=>i.toString().padStart(2,'0'));
      const hourData = hourLabels.map(h => data.by_hour[h]||0);
      new Chart(document.getElementById("hourChart"), {
        type: "bar",
        data: {
          labels: hourLabels,
          datasets: [{
            label: "Проблемы по часам",
            data: hourData,
            backgroundColor: "#2563eb"
          }]
        },
            options: {
          scales: { x: { title: { display: true, text: "Час" } }, y: { beginAtZero: true } }
        }
      });

      const tableLabels = Object.keys(data.by_table);
      const tableData = tableLabels.map(tbl => data.by_table[tbl]);
      new Chart(document.getElementById("tableChart"), {
        type: "bar",
        data: {
          labels: tableLabels,
          datasets: [{
            label: "Проблемы по таблицам",
            data: tableData,
            backgroundColor: "#16a34a"
          }]
        },
        options: {
          indexAxis: 'y',
          scales: { x: { beginAtZero: true } }
        }
      });

      const issueLabels = Object.keys(data.issues);
      const issueData = issueLabels.map(issue => data.issues[issue]);
      new Chart(document.getElementById("issueChart"), {
        type: "pie",
        data: {
          labels: issueLabels,
          datasets: [{
            data: issueData,
            backgroundColor: ["#ef4444","#f59e0b","#2563eb","#16a34a","#7c3aed","#d97706","#0369a1"]
          }]
        }
      });

      const topTables = Object.entries(data.by_table)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5);
      document.getElementById("topTables").innerHTML = topTables.map(([tbl,cnt]) =>
        `<li><b>${tbl}</b>: ${cnt} проблем</li>`
      ).join("");

      const topIssues = Object.entries(data.issues)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5);
      document.getElementById("topIssues").innerHTML = topIssues.map(([issue,cnt]) =>
        `<li><b>${issue}</b>: ${cnt} случаев</li>`
      ).join("");

      function applyFilters() {
        const tableVal = tableFilter.value;
        const issueVal = issueFilter.value;
        const hourVal = document.getElementById("hourFilter").value;

      }
      tableFilter.onchange = issueFilter.onchange = document.getElementById("hourFilter").oninput = applyFilters;
    });
  </script>
</body>
</html>